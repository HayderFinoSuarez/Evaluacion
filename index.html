<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluación de Licitación con Dashboard Mejorado</title>
  <style>
    /* Reset y base */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom right, #e0f2fe, #c7d2fe);
      min-height: 100vh;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Menú superior */
    .menu {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 16px;
      user-select: none;
      width: 100%;
      max-width: 960px;
    }
    .menu button {
      padding: 12px 24px;
      border: none;
      border-radius: 0.5rem 0.5rem 0 0;
      font-weight: 600;
      cursor: pointer;
      background-color: #e0e7ff;
      color: #1e40af;
      transition: background-color 0.3s ease;
      flex: 1;
      max-width: 200px;
      text-align: center;
    }
    .menu button.active {
      background-color: #2563eb;
      color: white;
      box-shadow: 0 -4px 6px -1px rgba(37, 99, 235, 0.7);
    }
    .menu button:hover:not(.active) {
      background-color: #c7d2fe;
    }

    /* Contenedor principal */
    main.contenedor {
      background: white;
      border-radius: 1rem;
      max-width: 960px;
      width: 100%;
      box-shadow: 0 25px 50px -12px rgba(99, 102, 241, 0.25);
      overflow: hidden;
      padding: 0;
      display: flex;
      flex-direction: column;
    }

    /* Secciones visibles/invisibles */
    main.contenedor > section {
      display: none;
      padding: 24px 32px;
    }
    main.contenedor > section.active {
      display: block;
    }

    /* Encabezado */
    .encabezado {
      background: linear-gradient(to right, #2563eb, #4f46e5);
      padding: 24px 32px;
      color: #e0e7ff;
      border-radius: 1rem 1rem 0 0;
    }
    .encabezado h1 {
      font-size: 2rem;
      font-weight: 700;
      margin: 0 0 6px 0;
    }
    .encabezado p {
      margin: 0;
      color: #bfdbfe;
    }

    /* Sección del formulario */
    .seccion-formulario {
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      padding: 24px 32px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }
    input[type="text"],
    input[type="date"],
    textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: box-shadow 0.2s ease;
      font-family: inherit;
    }
    input[type="text"]:focus,
    input[type="date"]:focus,
    textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 5px 2px #3b82f6aa;
    }
    textarea {
      resize: vertical;
    }

    /* Resumen de puntuación */
    .resumen-puntaje {
      padding: 24px 32px;
      background: linear-gradient(to right, #ecfdf5, #e0f2fe);
      border-bottom: 1px solid #d1d5db;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
    }
    .grupo-puntaje {
      display: flex;
      gap: 48px;
      align-items: center;
    }
    .bloque-puntaje {
      text-align: center;
    }
    .bloque-puntaje .puntaje {
      font-size: 2.25rem;
      font-weight: 700;
      color: #2563eb;
      margin-bottom: 4px;
    }
    .bloque-puntaje.cumplimiento .puntaje {
      color: #16a34a;
    }
    .bloque-puntaje .etiqueta {
      font-size: 0.875rem;
      color: #4b5563;
    }
    .boton-exportar {
      padding: 12px 28px;
      background-color: #2563eb;
      color: white;
      border-radius: 0.5rem;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      white-space: nowrap;
    }
    .boton-exportar:hover {
      background-color: #1d4ed8;
    }

    /* Requisitos */
    .requisitos {
      padding: 32px 0 0 0;
    }
    .bloque-categoria {
      margin-bottom: 48px;
    }
    .encabezado-categoria {
      display: flex;
      align-items: center;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 8px;
      margin-bottom: 20px;
      color: #374151;
      font-weight: 700;
      font-size: 1.25rem;
      gap: 8px;
    }
    .item-requisito {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
      transition: box-shadow 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .item-requisito:hover {
      box-shadow: 0 5px 15px rgb(0 0 0 / 0.15);
    }
    .info-requisito {
      flex: 1;
    }
    .numero-requisito {
      background: #f3f4f6;
      color: #374151;
      font-weight: 600;
      font-size: 0.875rem;
      padding: 3px 10px;
      border-radius: 0.5rem;
      margin-bottom: 6px;
      display: inline-block;
    }
    .descripcion-requisito {
      color: #4b5563;
      line-height: 1.4;
    }
    .grupo-botones {
      display: flex;
      gap: 10px;
      margin-left: 16px;
      flex-shrink: 0;
    }
    button.boton-estado {
      display: flex;
      align-items: center;
      gap: 6px;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      padding: 8px 14px;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      user-select: none;
      white-space: nowrap;
    }
    button.boton-estado svg {
      width: 16px;
      height: 16px;
    }
    button.cumple {
      background-color: #22c55e;
      color: white;
      box-shadow: 0 5px 10px rgb(34 197 94 / 0.6);
    }
    button.cumple:hover {
      background-color: #16a34a;
    }
    button.no-cumple {
      background-color: #ef4444;
      color: white;
      box-shadow: 0 5px 10px rgb(239 68 68 / 0.6);
    }
    button.no-cumple:hover {
      background-color: #b91c1c;
    }
    button.neutro {
      background-color: #f3f4f6;
      color: #4b5563;
    }
    button.neutro:hover {
      background-color: #d1d5db;
      color: #1f2937;
    }

    /* Observaciones */
    .observaciones {
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      padding: 24px 32px;
    }
    .observaciones label {
      font-size: 1.125rem;
      font-weight: 700;
      color: #374151;
      margin-bottom: 12px;
      display: block;
    }
    .observaciones textarea {
      width: 100%;
      min-height: 100px;
      font-size: 1rem;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-family: inherit;
      resize: vertical;
      transition: box-shadow 0.3s ease;
    }
    .observaciones textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 5px 2px #3b82f6aa;
    }

    /* Pie de página */
    .pie-pagina {
      background: #f3f4f6;
      padding: 16px 32px;
      text-align: center;
      font-size: 0.875rem;
      color: #6b7280;
      border-radius: 0 0 1rem 1rem;
    }

    /* Iconos SVG */
    .icono {
      width: 20px;
      height: 20px;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    /* Color iconos categoria */
    .encabezado-categoria svg {
      color: #2563eb;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .resumen-puntaje {
        flex-direction: column;
        align-items: flex-start;
      }
      .grupo-puntaje {
        gap: 32px;
        margin-bottom: 12px;
      }
      .boton-exportar {
        width: 100%;
      }
      .seccion-formulario {
        grid-template-columns: 1fr;
      }
      .menu button {
        max-width: 100%;
      }
      .estadisticas {
        flex-direction: column;
        align-items: stretch;
      }
    }

    /* Dashboard */
    .dashboard {
      background: #f3f4f6;
      border-radius: 1rem;
      box-shadow: 0 25px 50px -12px rgba(99, 102, 241, 0.25);
      padding: 24px 32px;
      color: #374151;
    }
    .dashboard h2 {
      color: #2563eb;
      margin-bottom: 16px;
    }
    .estadisticas {
      display: flex;
      justify-content: space-around;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 20px;
    }
    .estadistica {
      background: white;
      padding: 20px 32px;
      border-radius: 0.75rem;
      box-shadow: 0 1px 5px rgb(0 0 0 / 0.1);
      text-align: center;
      flex: 1 1 150px;
      min-width: 120px;
    }
    .estadistica .numero {
      font-size: 2.5rem;
      font-weight: 700;
      color: #2563eb;
    }
    .estadistica.cumple .numero {
      color: #16a34a;
    }
    .estadistica.no-cumple .numero {
      color: #ef4444;
    }
    .estadistica.no-evaluado .numero {
      color: #6b7280;
    }
    .estadistica .label {
      font-weight: 600;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 1px 5px rgb(0 0 0 / 0.1);
    }
    th, td {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      font-size: 0.95rem;
    }
    th {
      background-color: #2563eb;
      color: white;
      font-weight: 700;
    }
    tr:last-child td {
      border-bottom: none;
    }
    td.estado-cumple {
      color: #16a34a;
      font-weight: 600;
    }
    td.estado-no-cumple {
      color: #ef4444;
      font-weight: 600;
    }
    td.estado-no-evaluado {
      color: #6b7280;
      font-style: italic;
    }

    /* Selector de licitaciones */
    #selectorLicitaciones {
      width: 100%;
      max-width: 400px;
      margin: 12px 0 24px 0;
      padding: 8px 12px;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      font-size: 1rem;
    }

    /* Nueva sección orden licitaciones */
    #ordenLicitaciones {
      background: #fefefe;
      border-radius: 1rem;
      padding: 20px 24px;
      margin-top: 32px;
      box-shadow: 0 1px 8px rgb(0 0 0 / 0.12);
    }
    #ordenLicitaciones h3 {
      margin-top: 0;
      color: #2563eb;
      margin-bottom: 16px;
    }
    #tablaOrdenLicitaciones {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 24px;
    }
    #tablaOrdenLicitaciones th, #tablaOrdenLicitaciones td {
      padding: 10px 14px;
      border: 1px solid #e5e7eb;
      text-align: left;
    }
    #tablaOrdenLicitaciones th {
      background-color: #2563eb;
      color: white;
      font-weight: 600;
    }
    #graficoCumplimiento {
      max-width: 100%;
      height: 250px;
    }
  </style>
</head>
<body>
  <!-- Menú para cambiar entre formulario y dashboard -->
  <nav class="menu" role="tablist" aria-label="Menú principal">
    <button role="tab" aria-selected="true" aria-controls="seccionEvaluacion" id="tabEvaluacion" class="active">Evaluación</button>
    <button role="tab" aria-selected="false" aria-controls="seccionDashboard" id="tabDashboard">Dashboard</button>
  </nav>

  <main class="contenedor" role="main" aria-label="Formulario de Evaluación de Licitación">
    <!-- Sección Evaluación -->
    <section id="seccionEvaluacion" class="active" role="tabpanel" tabindex="0" aria-labelledby="tabEvaluacion">
      <!-- Encabezado -->
      <header class="encabezado">
        <h1>Formulario de Evaluación de Licitación</h1>
        <p>Evaluación de cumplimiento de requisitos técnicos</p>
      </header>

      <!-- Información Empresa y Evaluador -->
      <section class="seccion-formulario" aria-label="Información de la empresa y evaluador">
        <div>
          <label for="nombreEmpresa">Nombre de la Empresa</label>
          <input id="nombreEmpresa" type="text" placeholder="Ingrese el nombre de la empresa" />
        </div>
        <div>
          <label for="nombreEvaluador">Nombre del Evaluador</label>
          <input id="nombreEvaluador" type="text" placeholder="Ingrese su nombre" />
        </div>
        <div>
          <label for="fechaEvaluacion">
            Fecha
            <span aria-hidden="true">📅</span>
          </label>
          <input id="fechaEvaluacion" type="date" />
        </div>
      </section>

      <!-- Resumen de Puntaje -->
      <section class="resumen-puntaje" aria-live="polite" aria-atomic="true">
        <div class="grupo-puntaje">
          <div class="bloque-puntaje" aria-label="Requisitos cumplidos">
            <div class="puntaje" id="contadorPuntaje">0/22</div>
            <div class="etiqueta">Requisitos Cumplidos</div>
          </div>
          <div class="bloque-puntaje cumplimiento" aria-label="Porcentaje de cumplimiento">
            <div class="puntaje" id="porcentajeCumplimiento">0.0%</div>
            <div class="etiqueta">Cumplimiento</div>
          </div>
        </div>
        <button class="boton-exportar" id="botonExportar" type="button" aria-label="Exportar resultados de evaluación">Exportar Resultados</button>
      </section>

      <!-- Requisitos -->
      <section class="requisitos" aria-label="Lista de requisitos para evaluación">
        <!-- Aquí se inyectarán los requisitos -->
      </section>

      <!-- Observaciones -->
      <section class="observaciones">
        <label for="observaciones">Observaciones:</label>
        <textarea id="observaciones" placeholder="Ingrese observaciones adicionales sobre la evaluación..."></textarea>
      </section>

      <!-- Pie de página -->
      <footer class="pie-pagina">
        <p><strong>Sistema de Puntuación:</strong> CUMPLE = 1 PUNTO | NO CUMPLE = 0 PUNTOS</p>
      </footer>
    </section>

    <!-- Sección Dashboard -->
    <section id="seccionDashboard" role="tabpanel" tabindex="0" aria-labelledby="tabDashboard">
      <div class="dashboard">
        <h2>Dashboard de Resultados de Evaluación</h2>
        <input type="file" id="inputArchivo" accept=".json" aria-label="Importar archivos JSON de evaluación" multiple />
        <div id="mensajeArchivo" role="alert" style="color:#ef4444; margin-top:8px;"></div>

        <select id="selectorLicitaciones" aria-label="Seleccionar licitación para ver detalles" style="display:none;">
          <option value="" disabled selected>Seleccione una licitación</option>
        </select>

        <div id="resumenDashboard" style="display:none;">
          <div class="estadisticas" aria-live="polite" aria-atomic="true">
            <div class="estadistica cumple">
              <div class="numero" id="numCumple">0</div>
              <div class="label">Cumple</div>
            </div>
            <div class="estadistica no-cumple">
              <div class="numero" id="numNoCumple">0</div>
              <div class="label">No Cumple</div>
            </div>
            <div class="estadistica no-evaluado">
              <div class="numero" id="numNoEvaluado">0</div>
              <div class="label">No Evaluado</div>
            </div>
            <div class="estadistica">
              <div class="numero" id="porcentajeDashboard">0%</div>
              <div class="label">Porcentaje de Cumplimiento</div>
            </div>
          </div>

          <table aria-label="Detalles de requisitos evaluados">
            <thead>
              <tr>
                <th>N°</th>
                <th>Descripción</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="tablaResultados"></tbody>
          </table>
        </div>

        <section id="ordenLicitaciones" aria-label="Listado de licitaciones ordenadas por puntaje" style="display:none;">
          <h3>Licitaciones ordenadas por puntaje</h3>
          <table id="tablaOrdenLicitaciones" aria-live="polite" aria-atomic="true">
            <thead>
              <tr>
                <th>Nombre / Fecha</th>
                <th>Puntaje (cumplidos/total)</th>
                <th>% Cumplimiento</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <canvas id="graficoCumplimiento" role="img" aria-label="Gráfico de barras porcentaje de cumplimiento"></canvas>
        </section>
      </div>
    </section>
  </main>

  <!-- Carga Chart.js para gráfica -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    (() => {
      // Menú para cambiar secciones
      const btnEvaluacion = document.getElementById('tabEvaluacion');
      const btnDashboard = document.getElementById('tabDashboard');
      const seccionEvaluacion = document.getElementById('seccionEvaluacion');
      const seccionDashboard = document.getElementById('seccionDashboard');

      function cambiarSeccion(seleccion) {
        if (seleccion === 'evaluacion') {
          btnEvaluacion.classList.add('active');
          btnEvaluacion.setAttribute('aria-selected', 'true');
          btnDashboard.classList.remove('active');
          btnDashboard.setAttribute('aria-selected', 'false');
          seccionEvaluacion.classList.add('active');
          seccionDashboard.classList.remove('active');
          seccionEvaluacion.focus();
        } else {
          btnDashboard.classList.add('active');
          btnDashboard.setAttribute('aria-selected', 'true');
          btnEvaluacion.classList.remove('active');
          btnEvaluacion.setAttribute('aria-selected', 'false');
          seccionDashboard.classList.add('active');
          seccionEvaluacion.classList.remove('active');
          seccionDashboard.focus();
        }
      }
      btnEvaluacion.addEventListener('click', () => cambiarSeccion('evaluacion'));
      btnDashboard.addEventListener('click', () => cambiarSeccion('dashboard'));

      // Datos y estado evaluación
      const requisitos = [
        { id: 1, categoria: 'DOCUMENTACIÓN DE PRESENTACIÓN', descripcion: 'Entrega puntual conforme a las especificaciones establecidas, incluyendo el cumplimiento de sobre totalmente sellado.', estado: null },
        { id: 2, categoria: 'DOCUMENTACIÓN DE PRESENTACIÓN', descripcion: 'Carta de presentación de la propuesta', estado: null },
        { id: 3, categoria: 'DOCUMENTACIÓN DE PRESENTACIÓN', descripcion: 'Todos los documentos deberán incorporar una marca de agua visible con la leyenda "Uso Educativo"', estado: null },
        { id: 4, categoria: 'DOCUMENTACIÓN INSTITUCIONAL Y LEGAL', descripcion: 'Todos los documentos realizados por la empresa deberán tener su logo.', estado: null },
        { id: 5, categoria: 'DOCUMENTACIÓN INSTITUCIONAL Y LEGAL', descripcion: 'Copia de la cédula de ciudadanía de cada uno de los socios de la empresa.', estado: null },
        { id: 6, categoria: 'DOCUMENTACIÓN INSTITUCIONAL Y LEGAL', descripcion: 'Certificado de Existencia y Representación legal (cámara de comercio)', estado: null },
        { id: 7, categoria: 'DOCUMENTACIÓN INSTITUCIONAL Y LEGAL', descripcion: 'Acta de junta de socios o accionistas (autorización para contratar)', estado: null },
        { id: 8, categoria: 'DOCUMENTACIÓN INSTITUCIONAL Y LEGAL', descripcion: 'Certificados de Antecedentes Disciplinarios, Fiscales y Penales.', estado: null },
        { id: 9, categoria: 'DOCUMENTACIÓN INSTITUCIONAL Y LEGAL', descripcion: 'Póliza de seguro vigente.', estado: null },
        { id: 10, categoria: 'CAPACIDAD TÉCNICA Y DE TALENTO HUMANO', descripcion: 'Capacidad operacional Hojas de Vida y Soporte de los profesionales clave', estado: null },
        { id: 11, categoria: 'REQUISITOS FINANCIEROS Y ECONÓMICOS', descripcion: 'Requisitos financieros, Balance general, índice de liquidez.', estado: null },
        { id: 12, categoria: 'SEGURIDAD Y LEGALIDAD DEL SOFTWARE', descripcion: 'Propuesta económica formato anexo al pliego de condiciones.', estado: null },
        { id: 13, categoria: 'SEGURIDAD Y LEGALIDAD DEL SOFTWARE', descripcion: 'Análisis de riesgos y propuesta de mitigación.', estado: null },
        { id: 14, categoria: 'SEGURIDAD Y LEGALIDAD DEL SOFTWARE', descripcion: 'Documentación técnica de la seguridad.', estado: null },
        { id: 15, categoria: 'SEGURIDAD Y LEGALIDAD DEL SOFTWARE', descripcion: 'Propuesta de escalabilidad y mantenimiento a largo plazo.', estado: null },
        { id: 16, categoria: 'SEGURIDAD Y LEGALIDAD DEL SOFTWARE', descripcion: 'Certificado de modelo de licenciamiento del software.', estado: null },
        { id: 17, categoria: 'SEGURIDAD Y LEGALIDAD DEL SOFTWARE', descripcion: 'Carta de confidencialidad.', estado: null },
        { id: 18, categoria: 'PROPUESTA ECONÓMICA DETALLADA', descripcion: 'Formato de cotización componentes y servicios.', estado: null },
        { id: 19, categoria: 'PROPUESTA ECONÓMICA DETALLADA', descripcion: 'Análisis del valor total de la propuesta económica.', estado: null },
        { id: 20, categoria: 'PLANIFICACIÓN ESTRATÉGICA Y DE CAPACITACIÓN', descripcion: 'Plan claro de capacitación a los funcionarios de la entidad adquiriente del software.', estado: null },
        { id: 21, categoria: 'PLANIFICACIÓN ESTRATÉGICA Y DE CAPACITACIÓN', descripcion: 'Análisis de Innovación (Incluye mejoras tecnológicas).', estado: null },
        { id: 22, categoria: 'PLANIFICACIÓN ESTRATÉGICA Y DE CAPACITACIÓN', descripcion: 'Calidad y detalle de la documentación entregada y soporte ofrecido.', estado: null }
      ];

      const estado = {
        datosEvaluacion: {
          nombreEmpresa: '',
          nombreEvaluador: '',
          fecha: new Date().toISOString().split('T')[0],
          observaciones: ''
        },
        requisitos: JSON.parse(JSON.stringify(requisitos))
      };

      // Referencias DOM evaluación
      const inputNombreEmpresa = document.getElementById('nombreEmpresa');
      const inputNombreEvaluador = document.getElementById('nombreEvaluador');
      const inputFecha = document.getElementById('fechaEvaluacion');
      const textareaObservaciones = document.getElementById('observaciones');
      const seccionRequisitos = document.querySelector('.requisitos');
      const contadorPuntaje = document.getElementById('contadorPuntaje');
      const porcentajeCumplimiento = document.getElementById('porcentajeCumplimiento');
      const botonExportar = document.getElementById('botonExportar');

      // Iconos para categorías
      const iconos = {
        'DOCUMENTACIÓN': `<svg class="icono" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>`,
        'INSTITUCIONAL': `<svg class="icono" viewBox="0 0 24 24"><path d="M3 21v-8l9-4 9 4v8"/></svg>`,
        'TALENTO HUMANO': `<svg class="icono" viewBox="0 0 24 24"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a7 7 0 0 1 13 0"/></svg>`,
        'FINANCIERO': `<svg class="icono" viewBox="0 0 24 24"><path d="M12 1v22"/><path d="M17 5H9a4 4 0 0 0 0 8h6a4 4 0 0 1 0 8H7"/></svg>`,
        'SEGURIDAD': `<svg class="icono" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
        'ECONÓMICA': `<svg class="icono" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>`,
        'PLANIFICACIÓN': `<svg class="icono" viewBox="0 0 24 24"><polyline points="4 17 10 11 13 14 20 7"/><circle cx="20" cy="7" r="2"/></svg>`
      };

      // Funciones para evaluación
      function obtenerIcono(categoria) {
        if (categoria.includes('DOCUMENTACIÓN')) return iconos['DOCUMENTACIÓN'];
        if (categoria.includes('INSTITUCIONAL')) return iconos['INSTITUCIONAL'];
        if (categoria.includes('TALENTO HUMANO')) return iconos['TALENTO HUMANO'];
        if (categoria.includes('FINANCIERO')) return iconos['FINANCIERO'];
        if (categoria.includes('SEGURIDAD')) return iconos['SEGURIDAD'];
        if (categoria.includes('ECONÓMICA')) return iconos['ECONÓMICA'];
        if (categoria.includes('PLANIFICACIÓN')) return iconos['PLANIFICACIÓN'];
        return iconos['DOCUMENTACIÓN'];
      }

      function agruparRequisitos(lista) {
        return lista.reduce((acum, req) => {
          if (!acum[req.categoria]) acum[req.categoria] = [];
          acum[req.categoria].push(req);
          return acum;
        }, {});
      }

      function renderizarRequisitos() {
        const agrupados = agruparRequisitos(estado.requisitos);
        seccionRequisitos.innerHTML = '';
        Object.entries(agrupados).forEach(([categoria, reqs]) => {
          const bloqueCategoria = document.createElement('div');
          bloqueCategoria.className = 'bloque-categoria';

          const encabezadoCategoria = document.createElement('div');
          encabezadoCategoria.className = 'encabezado-categoria';
          encabezadoCategoria.innerHTML = `${obtenerIcono(categoria)}<span>${categoria}</span>`;
          bloqueCategoria.appendChild(encabezadoCategoria);

          reqs.forEach(req => {
            const item = document.createElement('div');
            item.className = 'item-requisito';

            const info = document.createElement('div');
            info.className = 'info-requisito';

            const numero = document.createElement('span');
            numero.className = 'numero-requisito';
            numero.textContent = `N° ${req.id}`;
            info.appendChild(numero);

            const descripcion = document.createElement('p');
            descripcion.className = 'descripcion-requisito';
            descripcion.textContent = req.descripcion;
            info.appendChild(descripcion);

            item.appendChild(info);

            const grupoBotones = document.createElement('div');
            grupoBotones.className = 'grupo-botones';

            const botonCumple = document.createElement('button');
            botonCumple.type = 'button';
            botonCumple.className = 'boton-estado';
            botonCumple.setAttribute('aria-pressed', req.estado === true ? 'true' : 'false');
            botonCumple.innerHTML = `<svg class="icono" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> CUMPLE`;
            botonCumple.classList.toggle('cumple', req.estado === true);
            botonCumple.classList.toggle('neutro', req.estado !== true);
            botonCumple.addEventListener('click', () => actualizarEstadoRequisito(req.id, true));
            grupoBotones.appendChild(botonCumple);

            const botonNoCumple = document.createElement('button');
            botonNoCumple.type = 'button';
            botonNoCumple.className = 'boton-estado';
            botonNoCumple.setAttribute('aria-pressed', req.estado === false ? 'true' : 'false');
            botonNoCumple.innerHTML = `<svg class="icono" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> NO CUMPLE`;
            botonNoCumple.classList.toggle('no-cumple', req.estado === false);
            botonNoCumple.classList.toggle('neutro', req.estado !== false);
            botonNoCumple.addEventListener('click', () => actualizarEstadoRequisito(req.id, false));
            grupoBotones.appendChild(botonNoCumple);

            item.appendChild(grupoBotones);
            bloqueCategoria.appendChild(item);
          });

          seccionRequisitos.appendChild(bloqueCategoria);
        });
      }

      function actualizarEstadoRequisito(id, estadoNuevo) {
        const requisito = estado.requisitos.find(r => r.id === id);
        if (requisito) {
          requisito.estado = estadoNuevo;
          renderizarRequisitos();
          actualizarPuntajes();
        }
      }

      function actualizarPuntajes() {
        const cumplidos = estado.requisitos.filter(r => r.estado === true).length;
        const total = estado.requisitos.length;
        const porcentaje = total === 0 ? 0 : ((cumplidos / total) * 100).toFixed(1);
        contadorPuntaje.textContent = `${cumplidos}/${total}`;
        porcentajeCumplimiento.textContent = `${porcentaje}%`;
      }

      function actualizarDatosEvaluacion(campo, valor) {
        estado.datosEvaluacion[campo] = valor;
      }

      // Exportar resultados incluyendo observaciones
      function exportarResultados() {
        const resultados = {
          informacionEvaluacion: estado.datosEvaluacion,
          puntaje: `${estado.requisitos.filter(r => r.estado === true).length}/${estado.requisitos.length}`,
          porcentajeCumplimiento: ((estado.requisitos.filter(r => r.estado === true).length / estado.requisitos.length) * 100).toFixed(1) + '%',
          observaciones: estado.datosEvaluacion.observaciones,
          requisitos: estado.requisitos.map(r => ({
            id: r.id,
            descripcion: r.descripcion,
            estado: r.estado === true ? 'CUMPLE' : r.estado === false ? 'NO CUMPLE' : 'NO EVALUADO'
          }))
        };
        const datosStr = JSON.stringify(resultados, null, 2);
        const blob = new Blob([datosStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const fechaSegura = (estado.datosEvaluacion.fecha || new Date().toISOString().split('T')[0]).replace(/:/g, '-');
        const empresaSegura = (estado.datosEvaluacion.nombreEmpresa || 'empresa').replace(/\s+/g, '_');
        a.href = url;
        a.download = `evaluacion_licitacion_${empresaSegura}_${fechaSegura}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function inicializarInputs() {
        inputNombreEmpresa.value = estado.datosEvaluacion.nombreEmpresa;
        inputNombreEvaluador.value = estado.datosEvaluacion.nombreEvaluador;
        inputFecha.value = estado.datosEvaluacion.fecha;
        textareaObservaciones.value = estado.datosEvaluacion.observaciones;
      }

      inputNombreEmpresa.addEventListener('input', e => actualizarDatosEvaluacion('nombreEmpresa', e.target.value));
      inputNombreEvaluador.addEventListener('input', e => actualizarDatosEvaluacion('nombreEvaluador', e.target.value));
      inputFecha.addEventListener('input', e => actualizarDatosEvaluacion('fecha', e.target.value));
      textareaObservaciones.addEventListener('input', e => actualizarDatosEvaluacion('observaciones', e.target.value));
      botonExportar.addEventListener('click', exportarResultados);

      inicializarInputs();
      renderizarRequisitos();
      actualizarPuntajes();

      // Dashboard variables y referencias
      const inputArchivo = document.getElementById('inputArchivo');
      const mensajeArchivo = document.getElementById('mensajeArchivo');
      const resumenDashboard = document.getElementById('resumenDashboard');
      const numCumple = document.getElementById('numCumple');
      const numNoCumple = document.getElementById('numNoCumple');
      const numNoEvaluado = document.getElementById('numNoEvaluado');
      const porcentajeDashboard = document.getElementById('porcentajeDashboard');
      const tablaResultados = document.getElementById('tablaResultados');
      const selectorLicitaciones = document.getElementById('selectorLicitaciones');
      const ordenLicitacionesSection = document.getElementById('ordenLicitaciones');
      const tablaOrdenLicitacionesBody = document.querySelector('#tablaOrdenLicitaciones tbody');
      const graficoCumplimientoCanvas = document.getElementById('graficoCumplimiento');

      let licitacionesCargadas = [];
      let chart = null;

      function mostrarLicitacion(index) {
        if (index < 0 || index >= licitacionesCargadas.length) return;
        const licitacion = licitacionesCargadas[index];

        let cumpleCount = 0;
        let noCumpleCount = 0;
        let noEvaluadoCount = 0;
        licitacion.requisitos.forEach(r => {
          if (r.estado === 'CUMPLE') cumpleCount++;
          else if (r.estado === 'NO CUMPLE') noCumpleCount++;
          else noEvaluadoCount++;
        });
        const total = licitacion.requisitos.length;
        const porcentaje = total === 0 ? 0 : ((cumpleCount / total) * 100).toFixed(1);

        numCumple.textContent = cumpleCount;
        numNoCumple.textContent = noCumpleCount;
        numNoEvaluado.textContent = noEvaluadoCount;
        porcentajeDashboard.textContent = porcentaje + '%';

        tablaResultados.innerHTML = '';
        licitacion.requisitos.forEach(r => {
          const tr = document.createElement('tr');
          const tdId = document.createElement('td');
          tdId.textContent = r.id;
          const tdDesc = document.createElement('td');
          tdDesc.textContent = r.descripcion;
          const tdEstado = document.createElement('td');
          tdEstado.textContent = r.estado;
          if (r.estado === 'CUMPLE') tdEstado.className = 'estado-cumple';
          else if (r.estado === 'NO CUMPLE') tdEstado.className = 'estado-no-cumple';
          else tdEstado.className = 'estado-no-evaluado';

          tr.appendChild(tdId);
          tr.appendChild(tdDesc);
          tr.appendChild(tdEstado);

          tablaResultados.appendChild(tr);
        });

        resumenDashboard.style.display = 'block';
      }

      // Actualiza tabla ordenada y gráfica
      function actualizarOrdenYGrafica() {
        // Ordenar por porcentaje de cumplimiento descendente
        licitacionesCargadas.sort((a, b) => b.porcentajeCumplimiento - a.porcentajeCumplimiento);

        // Tabla ordenada
        tablaOrdenLicitacionesBody.innerHTML = '';
        licitacionesCargadas.forEach(lic => {
          const tr = document.createElement('tr');
          const tdNombre = document.createElement('td');
          tdNombre.textContent = lic.titulo;
          const tdPuntaje = document.createElement('td');
          tdPuntaje.textContent = `${lic.cumplidos}/${lic.total}`;
          const tdPorcentaje = document.createElement('td');
          tdPorcentaje.textContent = lic.porcentajeCumplimiento.toFixed(1) + '%';

          tr.appendChild(tdNombre);
          tr.appendChild(tdPuntaje);
          tr.appendChild(tdPorcentaje);
          tablaOrdenLicitacionesBody.appendChild(tr);
        });

        ordenLicitacionesSection.style.display = licitacionesCargadas.length ? 'block' : 'none';

        // Gráfica con Chart.js
        const etiquetas = licitacionesCargadas.map(l => l.titulo);
        const datos = licitacionesCargadas.map(l => l.porcentajeCumplimiento);

        if (chart) {
          chart.data.labels = etiquetas;
          chart.data.datasets[0].data = datos;
          chart.update();
        } else {
          chart = new Chart(graficoCumplimientoCanvas.getContext('2d'), {
            type: 'bar',
            data: {
              labels: etiquetas,
              datasets: [{
                label: '% Cumplimiento',
                data: datos,
                backgroundColor: '#2563eb'
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  ticks: { stepSize: 10 },
                  title: { display: true, text: 'Porcentaje (%)' }
                },
                x: {
                  ticks: { maxRotation: 90, minRotation: 45 }
                }
              },
              plugins: {
                legend: { display: false },
                tooltip: { enabled: true }
              }
            }
          });
        }
      }

      inputArchivo.addEventListener('change', () => {
        mensajeArchivo.textContent = '';
        resumenDashboard.style.display = 'none';
        tablaResultados.innerHTML = '';
        selectorLicitaciones.style.display = 'none';
        selectorLicitaciones.innerHTML = '<option value="" disabled selected>Seleccione una licitación</option>';
        ordenLicitacionesSection.style.display = 'none';
        tablaOrdenLicitacionesBody.innerHTML = '';
        licitacionesCargadas = [];

        const archivos = Array.from(inputArchivo.files);
        if (archivos.length === 0) {
          mensajeArchivo.textContent = 'No se seleccionó ningún archivo.';
          return;
        }

        let archivosProcesados = 0;
        let errorOcurrido = false;

        archivos.forEach((archivo, idx) => {
          if (!archivo.name.endsWith('.json')) {
            mensajeArchivo.textContent = `Archivo no válido: ${archivo.name}`;
            errorOcurrido = true;
            return;
          }
          const lector = new FileReader();
          lector.onload = (e) => {
            try {
              const datos = JSON.parse(e.target.result);
              if (!datos.requisitos || !Array.isArray(datos.requisitos)) {
                mensajeArchivo.textContent = `Archivo JSON inválido: ${archivo.name}`;
                errorOcurrido = true;
                return;
              }
              let titulo = 'Licitación sin nombre';
              if (datos.informacionEvaluacion) {
                const empresa = datos.informacionEvaluacion.nombreEmpresa || '';
                const fecha = datos.informacionEvaluacion.fecha || '';
                titulo = empresa && fecha ? `${empresa} (${fecha})` : empresa || fecha || titulo;
              }

              let cumplidos = 0;
              datos.requisitos.forEach(r => {
                if (r.estado === 'CUMPLE') cumplidos++;
              });
              const total = datos.requisitos.length;
              const porcentajeCumplimiento = total === 0 ? 0 : (cumplidos / total) * 100;

              licitacionesCargadas.push({
                titulo,
                requisitos: datos.requisitos,
                cumplidos,
                total,
                porcentajeCumplimiento
              });

              archivosProcesados++;
              if (archivosProcesados === archivos.length && !errorOcurrido) {
                selectorLicitaciones.style.display = 'block';
                selectorLicitaciones.innerHTML = '<option value="" disabled selected>Seleccione una licitación</option>';
                licitacionesCargadas.forEach((lic, i) => {
                  const option = document.createElement('option');
                  option.value = i;
                  option.textContent = lic.titulo;
                  selectorLicitaciones.appendChild(option);
                });
                selectorLicitaciones.selectedIndex = 1;
                mostrarLicitacion(0);
                actualizarOrdenYGrafica();
              }
            } catch (error) {
              mensajeArchivo.textContent = `Error leyendo JSON en archivo ${archivo.name}: ${error.message}`;
              errorOcurrido = true;
            }
          };
          lector.readAsText(archivo);
        });
      });

      selectorLicitaciones.addEventListener('change', (e) => {
        const index = parseInt(e.target.value, 10);
        mostrarLicitacion(index);
      });
    })();
  </script>
</body>
</html>

                                    
